\section{Type-checking rules}\label{app::typeassn}The rules are defined with respect to a given store s.\axiom {C,E \vdash_s \texttt{ok}:\texttt{PROGRAM}} {OK}\axiom{C,E \vdash_s \com:\Com}{Command}\axiom{C,E \vdash_s \texttt{nil}:\texttt{Null}}{Nil}\infrule{\emptyset \vdash c :\TP\ \ \ \ \ \ \ b \in \Im (c)}{C,E \vdash_s b : c }{}{Constant}\infrule{\emptyset \vdash \tau :\texttt{TYPE}}{C,E \vdash_s error :\tau }{}{Error}\infrule {\emptyset \vdash \tau :\texttt{TYPE}, \ \ \ L\in Loc_\tau \capdom(s)} {C,E \vdash_s L:\rf\ \tau } {}{Location}%\infrulebig%{\begin{array}{c}%\emptyset \vdash \TobjV(\MT,\sigma ,\tau ):TYPE, \\%L\in Loc_{\TobjV(\MT,\sigma ,\tau )}\cap dom(s),\ \ \sigma \textrm{ a record type}%\end{array}} {C,E \vdash_s L:\Tobj(\MT,\tau%)}%{}{Location^{Obj}}\axiom{C,E \vdash_s x:\tau \ \ \ \ \ \ \ if\ \ \ E(x)=\tau}{Variable}\infrule{C,E \vdash_s B\ :\ \Com}{C,E \vdash_s \texttt{program}\ p;\ B.\ :\ \texttt{PROGRAM}}{}{Program}\infrule{C,E \vdash_s CDclLst\ \diamond \ E*}{C,E \vdash_s \texttt{const}\ CDclLst\ \diamond \ E*}{}{ConstDecls }\infrule{C,E \vdash_s x=M\ \diamond \ E_1\ \ \ \ \ \ C,E_1 \vdash_s CDclLst\\diamond \ E_2}{C,E \vdash_s x=M\ ;\ CDclLst\ \diamond \ E_2}{}{ConstDcl* }\infrule{C,E \vdash_s M:\tau \ \ \ \ \ x\notin dom(E)}{C,E \vdash_s x=M\ \diamond \ E\cup \{x:\tau \}}{}{ConstDcl }\infrule{C,E \vdash_s VDclLst\ \diamond \ E*}{C,E \vdash_s \texttt{var} \ VDclLst\ \diamond \ E*}{}{VarDecls }\infrule{C,E \vdash_s x:\tau \ \diamond \ E_1\ \ \ \ \ \ \ \ C,E_1 \vdash_sVDclLst\ \diamond \ E_2}{C,E \vdash_s x:\tau \ ;\ VDclLst\ \diamond \ E_2}{}{VarDcl* }\infrule{C \vdash \tau :TYPE\ \ \ \ \ \ \ x\notin dom(E)}{C,E \vdash_s x:\tau \ \ \diamond \ E\cup \{x:\rf\ \tau \}}{}{VarDcl }\infrule{\begin{array}{c}C,E \vdash_s CDcls\ \diamond \ E_1\ \ \ \ \ C,E_1 \vdash_s VDcls\ \diamond\ E_2\\C,E_2 \vdash_s S:\Com\ \ \ \ \ \ \ C,E_2 \vdash_s M:\tau\\\end{array}}{C,E \vdash_s CDcls\ \ VDcls\ \texttt{begin}\ S\ \texttt{return}\ M\\texttt{end}:\tau } {}{Block }\infrule{C,E \vdash_s x:\rf\ \tau \ \ \ \ \ \ \ C,E \vdash_s M:\tau }{C,E \vdash_s x:=M:\Com}{}{Assn }\infrule {C,E \vdash_s M:\texttt{Bool}\ \ \ \ \ C,E \vdash_s S_1:\Com\\ \ \ \ C,E \vdash_s S_2:\Com} {C,E \vdash_s \texttt{if}\ \ M\ \\texttt{then}\ \ S_1\ \ \texttt{else}\ \ S_2\ \ \texttt{end}:\Com} {}{Cond }\infrule{C,E \vdash_s M:\texttt{Bool}\ \ \ \ \ C,E \vdash_s S:\Com}{C,E \vdash_s \texttt{while}\ \ B\ \ \texttt{do}\ \ S\ \ \texttt{end}:\Com}{}{While }\infrule{C,E \vdash_s S_1:\Com\ \ \ \ \ C,E \vdash_s S_2:\Com}{C,E \vdash_s S_1;S_2:\Com}{}{StmtList }\infrule{C,E \vdash_s M:\rf\ \tau }{C,E \vdash_s \texttt{val}\ \ M\ :\tau }{}{Value }\infrule{C,E\cup \{x:\sigma \} \vdash_s B:\tau \ }{C,E \vdash_s \texttt{function}(x:\sigma )\ B:\sigma \to \tau }{}{Function }\infrule{C\cup \{t:\texttt{TYPE}\},E \vdash_s B:\tau \ }{C,E \vdash_s \texttt{function}(t:\texttt{TYPE})\ B:\forall t.\tau }{}{PolyFunction }\infrule{C\cup \{t \leI \gamma \},E \vdash_s B:\tau \ }{C,E \vdash_s \texttt{function}(t \leI \gamma )\ B:\forall t \leI \gamma .\tau }{}{\leI BdPolyFunction }\infrule{C\cup \{t<:\gamma \},E \vdash_s B:\tau \ }{C,E \vdash_s \texttt{function}(t<:\gamma )\ B:\forall t<:\gamma .\tau }{}{\leS BdPolyFunction }\infrule {C,E \vdash_s M_1:\sigma \to \tau \ \ \ \ \ C,E \vdash_sM_2:\sigma } {C,E \vdash_s M_1(M_2):\tau } {}{FuncAppl }\infrule{C,E \vdash_s M:\forall t.\tau \ \ \ \ \ C \vdash_s \sigma :TYPE}{C,E \vdash_s M[\sigma ]:\tau [t\mapsto \sigma ]}{}{PolyFuncAppl }\infrule{C,E \vdash_s M:\forall t \leI \gamma .\tau \ \ \ \ \ C \vdash_s \sigma\leI \gamma }{C,E \vdash_s M[\sigma ]:\tau [t\mapsto \sigma ]}{}{\leI BdPolyFuncAppl }\infrule{C,E \vdash_s M:\forall t<:\gamma .\tau \ \ \ \ \ C \vdash_s \sigma <:\gamma }{C,E \vdash_s M[\sigma ]:\tau [t\mapsto \sigma ]}{}{\leS BdPolyFuncAppl }\infrule{C,E \vdash_s M_i:\tau _i\ and \ l_{i}\in {\cal L}\ for\ 1\le i\le n\ }{C,E \vdash_s \{l_i=M_i:\tau_i\}_{i \le n}:\{l_i:\tau_i\}_{i \le n}}{}{Record }\infrule{C,E \vdash_s M:\{l_i:\tau_i\}_{i \le n}}{C,E \vdash_s M.l_i:\tau _i}{\textrm{for all}\ 1\le i\le n}{Proj }\infrulebig{\begin{array}{c}C,E \vdash_s M_a:\{iv_i:\forall \MT \leI \Tobj(\MT,\tau ).\sigma_i,\}_{i \le k}\\C,E \vdash_s M_b:\{m_j:\forall \MT \leI \Tobj(\MT,\tau ).\rjust\\\hspace*{1.5in}\forall \ST<:\RM(\sigma ).\MT\to \ST\to \tau_j\}_{j \le n}\rjust\end{array}}{C,E \vdash_s \texttt{class}(M_a,M_b):\Tclass(\MT,\sigma ,\tau )}{}{Class }$\begin{array}{l@{}l}\textrm{where } &\tau = \{m_{j}:\tau_{j}\}_{j \le n},\ \ST\notin FV(\tau),\\sigma = \{l_{i}:\sigma_{i}\}_{i \le k}, \textrm{ and} \\ &\RM(\{l_{i}:\sigma_{i}\}_{i \le k}) =\{l_{i}:\rf\ \sigma_{i}\}_{i \le k}\end{array}$\vspace{2ex}\infrule{C,E \vdash_s M:\Tclass(\MT,\sigma ,\tau )}{C,E \vdash_s \texttt{new}\ M:\Tobj(\MT,\tau )}{}{New }\infrule {C \vdash \gamma  \leI \Tobj(\MT,\{m:\tau\})\ \ \ \ C,E\vdash_s M:\gamma } {C,E \vdash_s M\Leftarrow m:(\tau[\MT\mapsto\gamma ])} {}{Msg }\infrulebig {\begin{array}{c} C,E \vdash_sM:\Tclass(\MT,\{iv_i:\sigma_i\}_{i \le n},  \{m_j:\tau_j\}_{j \le k})\\C\cup \{\MT \leI \Tobj(\MT,\{m_j: \tau'_j\}_{j \le k+1})\}\vdash  \tau'_1<:\tau _1\\C,E \vdash_s M_1^V:\sigma_1^\forall\\C,E \vdash_s M_{n+1}^V:\sigma_{n+1}^\forall\\C,E \vdash_s M_1^f:\{m_j:\tau_j^\forall\}_{j \le k} \to \delta_1\\C,E \vdash_s M_{k+1}^f:\{m_j:\tau_j^\forall\}_{j \le k}\to\delta_{k+1}\end{array}}{\begin{array}{c}C,E \vdash_s \texttt{class inherit}\ M\ \texttt{modifying}\ iv_1,m_1;\rjust\\\hspace*{0.7in}(\{iv_1=M_1^V:\sigma _1^\forall,iv_{n+1}=M_{n+1}^V:\sigma _{n+1}^\forall \},\rjust\\\hspace*{0.75in}\{m_1=M_1^f:\{m_j:\tau _j^\forall \}_{j \le k}\to \delta _1,\rjust\\\hspace*{0.83in}m_{k+1}=M_{k+1}^f:\{m_j:\tau _j^\forall \}_{j \lek}\to \delta _{k+1}\}):\rjust\\\hspace*{0.5in}\Tclass(\MT,\{iv_i:\sigma _i\}_{i \le n+1},\{m_i:\tau'_i\}_{i \le k+1})\rjust\end{array}}{}{Inherits } $\begin{array}{l@{}l} \textrm{where } &\sigma_i^\forall=\forall \MT \leI \Tobj(\MT,\{m_j:\tau'_{j}\}_{j \le k+1}).\sigma_i,\textrm{ for } 1 \le i \le n+1,\\& \tau_l^\forall =\forall \MT \leI\Tobj(\MT,\{m_j:\tau _j\}_{j \le n}).\\&\hspace*{0.55in}\forall \ST<:\RTM(\{iv_i:\sigma _i\}_{i \le n}). \MT\to \ST\to \tau_l, \textrm{ for } 1 \le l \le k,\\& \delta_p=\forall \MT \leI\Tobj(\MT,\{m_j:\tau'_j\}_{j \le k+1}).  \\& \hspace*{0.55in} \forall \ST<:\RTM(\{iv_i:\sigma _i\}_{i \le n+1}). \MT\to \ST\to \tau'_p, \textrm{ for } 1 \le p \le k+1\\& \tau'_j=\tau_j\ \textrm{for } 2 \le j \le k, \textrm{and}\\&\ST \not\in FV(\tau'_{1})\cup FV(\tau'_{k+1})\end{array}$\infrule{C \vdash_s \sigma <:\tau \ \ \ \ \ C,E \vdash_s M:\sigma }{C,E \vdash_s M:\tau }{}{Subsump }\infrule {\hat C,\hat E \vdash_s f: \sigma \to \tau \ \ and\ \ \rho \\models_s\ \hat C,\hat E} {C,E \vdash_s \langle f,\rho \rangle:\sigma_\rho \to \tau _\rho } {}{\textit{Closure }_{\to} }\infrule {\hat C,\hat E \vdash_s f: \forall t.\tau \ \ and\ \ \rho \\models_s\ \hat C,\hat E} {C,E \vdash_s \langle f,\rho \rangle:\forall t.\tau_\rho } {}{\textit{Closure }_{\forall} }\infrule {\hat C,\hat E \vdash_s f: \forall t \leI \gamma .\tau \ \ and\ \ \rho \\models_s\ \hat C,\hat E} {C,E \vdash_s \langle f,\rho \rangle:\forall t \leI \gamma_\rho.\tau_\rho } {}{\textit{Closure }_{\forall \leI} }\infrule {\hat C,\hat E \vdash_s f: \forall t <: \gamma .\tau \ \ and\ \ \rho \\models_s\ \hat C,\hat E} {C,E \vdash_s \langle f,\rho \rangle:\forall t <: \gamma_\rho .\tau_\rho } {}{\textit{Closure }_{\forall<:} }An analogous rule holds for polymorphic (resp. bounded polymorphic) functions.%\infrule%{\begin{array}{c}%C,E\  \vdash_s M_a:(\RTM(\sigma )[\MT\mapsto \Tobj(\MT,\tau )])\\%C,E \vdash_s M_b\ :\ \{\ldots ,m_j:\Tobj(\MT,\tau )\rjust\\%\hspace*{1.6in}\to \RTM(\sigma )[\MT\mapsto \Tobj(\MT,\tau )]\rjust\\%\hspace*{1.6in}\to \tau _j[\MT\mapsto \Tobj(\MT,\tau )],\ldots \}\rjust%\end{array}}%{C,E \vdash_s obj(M_a,M_b)\ :\ \TobjV(\MT,\sigma ,\tau )}%{}{Object }\infrule {\begin{array}{c}C,E\  \vdash_s M_a:(\RTM(\sigma )[\MT\mapsto \Tobj(\MT,\tau )])\\C,E \vdash_s M_b\ :\ \{m_j:(\MT \to \RTM(\sigma ) \to \tau_j)\rjust\\\hspace*{1.9in}[\MT\mapsto \Tobj(\MT,\tau )] \}_{j\leq m}\rjust\end{array}}{C,E \vdash_s \texttt{obj}(M_a,M_b)\ :\ \Tobj(\MT,\tau )} %TobjV{}{Object}